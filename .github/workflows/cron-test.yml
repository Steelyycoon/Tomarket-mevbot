name: Upload test

on:
  push:
    paths:
      - '.github/workflows/cron-test.yml'
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  upload-test:
    name: Upload test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 16
      - uses: bahmutov/npm-install@v1
      - run: npm install -g @web3-storage/w3
      - name: Add small file via w3
        run: |
          echo "$(date --utc --iso-8601=seconds) web3.storage upload test" > ./upload-test-small 
          w3 put ./upload-test-small --token ${{ secrets.WEB3_TOKEN }}

      # test adding a file larger than LOCAL_ADD_THRESHOLD see: packages/api/src/constants.js
      # Create a random file. upload it via w3 and time the duration in seconds
      # `usr/bin/time -f "%e" -o ./duration_secs` writes the wall-clock runtime in seconds of the command to the file ./duration_secs
      # the rest is wrapping it up as a metric in the prometheus format and sending it off to the push gateway
      # see: https://github.com/prometheus/pushgateway/blob/master/README.md
      - name: Add 3MiB file via w3 and push duration to prometheus push gateway
        run: |
          dd if=/dev/urandom of=./upload-test-3mib bs=1024 count=3072
          /usr/bin/time -f "%e" -o ./duration_secs w3 put ./upload-test-3mib --token ${{ secrets.WEB3_TOKEN }}
          cat ./duration_secs 
          echo "# HELP web3storage_upload_duration_seconds How long it took to upload a file via w3" > ./metric
          echo "# TYPE web3storage_upload_duration_seconds gauge" >> ./metric
          echo "web3storage_upload_duration_seconds{endpoint=\"/car\",size=\"3MiB\",cmd=\"w3\"} $(cat ./duration_secs)" >> ./metric
          cat ./metric
          curl --silent --show-error --data-binary "@./metric" --basic --user "${{ secrets.PUSHGATEWAY_BASIC_AUTH }}" https://pushgateway.k8s.locotorp.info/metrics/job/web3storage_ci/instance/github_action

      - uses: ibnesayeed/setup-ipfs@aff2e4ae38368a44ac36ecc244f8c693d2e5b263
        with:
          ipfs_version: '0.18.1'
          run_daemon: true

      - name: Pin 3MiB file via kubo and push duration to prometheus push gateway
        run: |
          ipfs pin remote service add web3 "https://api.web3.storage" ${{ secrets.WEB3_TOKEN }}
          dd if=/dev/urandom of=./pin-test-3mib bs=1024 count=3072
          ipfs add --quiet --cid-version=1 ./pin-test-3mib > ./cid-to-pin
          /usr/bin/time -f "%e" -o ./pin_duration_secs ipfs pin remote add --service=web3 --name=foo $(cat ./cid-to-pin)
          cat ./pin_duration_secs
          echo "# HELP web3storage_pin_duration_seconds How long it took to pin a file via kubo" > ./pin_metric
          echo "# TYPE web3storage_pin_duration_seconds gauge" >> ./pin_metric
          echo "web3storage_pin_duration_seconds{size=\"3MiB\",cmd=\"kubo\"} $(cat ./pin_duration_secs)" >> ./pin_metric
          cat ./pin_metric
          curl --silent --show-error --data-binary "@./pin_metric" --basic --user "${{ secrets.PUSHGATEWAY_BASIC_AUTH }}" https://pushgateway.k8s.locotorp.info/metrics/job/web3storage_ci/instance/github_action

      - name: Heartbeat
        if: ${{ success() }}
        run: ./packages/tools/scripts/cli.js heartbeat --token ${{ secrets.OPSGENIE_KEY }} --name cron-web3storage-upload-test
